# Approvers

Source code for the `Approvers` team's agent in the [FIDE & Google Efficient Chess AI Challenge][kaggle].

The engine is based on [Cfish][cfish], a C port of [Stockfish][stockfish].

## NNUE

The NNUE architecture is `(768x1hm -> 64)x2 -> 1x8`, being a pretty common pattern in the chess
programming community â€” 1 hidden layer with `768` features (2 colors * 6 piece types * 64 squares)
with implementation-specific modifications.

- Horizontal king mirroring: inputs are flipped along the vertical axis, i.e., `a1` becomes `h1`, `b1` becomes `g1`, etc., based on the position of the friendly king.
- 8 output buckets based on the number of pieces left on the board: `(piece_count - 2) / 4`.
- SCReLU (Squared Clipped Rectified Linear Unit) activation function: `f(x) = min(max(x, 0), 1)^2`.

The network training involves 3-stages of progressive training, with each stage restarting
from the previous one with modifications, finally followed by an [SPSA][spsa] session.

For the full training configuration, see [`training/config.rs`](training/config.rs).

The network is quantized to 8 bits for FT weights/biases and L1 weights, and 16 bits for L1 biases. 
Also, due to unused features for pawns (1st and 8th ranks being illegal by the rules of chess)
and the mirror squares of kings, the input features are reduced to `704`.

The resulting network size is around 45 KB.

## Training data

The dataset is based on [test77-nov2021-2tb7p.min.dd.binpack][test77], originally generated by the
[Leela Chess Zero project][lc0-data] and made available under the [Open Database License][odbl] (ODbL).

For further use in the [Bullet][bullet] trainer, the dataset was filtered and converted into the [bulletformat][bulletformat] format,
using the [Primer][primer] tool with the following command:

```bash
./primer convert test77-nov2021-2tb7p.min.dd.binpack dataset.bin --max-score 2400 --filter-win -600 --filter-loss 600 --min-ply 20
```

[kaggle]: https://www.kaggle.com/competitions/fide-google-efficiency-chess-ai-challenge/overview
[cfish]: https://github.com/syzygy1/Cfish
[stockfish]: https://github.com/official-stockfish/Stockfish
[primer]: https://github.com/PGG106/Primer
[bulletformat]: https://github.com/jw1912/bulletformat
[bullet]: https://github.com/jw1912/bullet
[test77]: https://www.kaggle.com/datasets/linrock/1ee1aba5ed-test60-2020-test77-nov2021-2tb7p?select=test77-nov2021-2tb7p.min.dd.binpack
[lc0-data]: https://storage.lczero.org/files/training_data
[odbl]: https://opendatacommons.org/licenses/odbl/odbl-10.txt
[nnue]: https://www.chessprogramming.org/NNUE
[spsa]: https://en.wikipedia.org/wiki/Simultaneous_perturbation_stochastic_approximation
